{% extends "base.html" %}

{% block content %}
<div class="profile-page-container">
    <!-- Page Header -->
    <div class="profile-page-header">
        <h1 class="profile-page-title">Personal center</h1>
        <p class="profile-page-subtitle">Manage your profile and account settings</p>
    </div>

    <!-- Main Content Grid -->
    <div class="profile-main-grid">
        <!-- Left Column -->
        <div class="profile-left-column">
            <!-- User Profile Card -->
            <div class="user-profile-card card-shadow">
                <div class="profile-avatar-container">
                    <div class="profile-avatar-large" style="background-color: {{ g.user_avatar_color|default('#ffd700') }}">
                        {{ g.initials|default('UU') }}
                    </div>
                    <button class="avatar-edit-btn" onclick="openEditProfileModal()">
                        <i class="fas fa-camera"></i>
                    </button>
                </div>
                <div class="profile-name">{{ user.first_name }} {{ user.last_name }}</div>
                <div class="profile-school-info">
                    {{ user.school if user.school else 'No School' }} • {{ grade_display }}
                </div>
                <div class="profile-badges">
                    <span class="profile-badge badge-education">{{ education_display }}</span>
                    <span class="profile-badge badge-checkin">{{ this_month_checkins }} days checked in</span>
                    <span class="profile-badge badge-streak">{{ streak_days }} day{{ 's' if streak_days != 1 else '' }} streak</span>
                </div>
            </div>

            <!-- Personal Information Section -->
            <div class="personal-info-section card-shadow">
                <div class="section-header-with-action">
                    <div>
                        <h2 class="section-title">Personal Information</h2>
                        <p class="section-subtitle">Your basic profile details</p>
                    </div>
                    <button class="btn-edit-section" onclick="openEditProfileModal()">
                        <i class="fas fa-pencil-alt"></i> Edit
                    </button>
                </div>
                <div class="info-details-list">
                    <div class="info-detail-item">
                        <i class="fas fa-user info-icon"></i>
                        <div class="info-content">
                            <span class="info-label">Gender</span>
                            <span class="info-value">{{ 'Male' if user.gender == 'male' else 'Female' if user.gender == 'female' else 'Not set' }}</span>
                        </div>
                    </div>
                    <div class="info-detail-item">
                        <i class="far fa-calendar info-icon"></i>
                        <div class="info-content">
                            <span class="info-label">Date of Birth</span>
                            <span class="info-value">
                                {% if user.birth_date %}
                                    {% set birth_date = user.birth_date.split(' ')[0] if ' ' in user.birth_date else user.birth_date %}
                                    {% set date_parts = birth_date.split('-') %}
                                    {% if date_parts|length == 3 %}
                                        {% set months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'] %}
                                        {{ months[date_parts[1]|int - 1] }} {{ date_parts[2]|int }}, {{ date_parts[0] }}
                                    {% else %}
                                        {{ user.birth_date }}
                                    {% endif %}
                                {% else %}
                                    Not set
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    <div class="info-detail-item">
                        <i class="fas fa-school info-icon"></i>
                        <div class="info-content">
                            <span class="info-label">School</span>
                            <span class="info-value">{{ user.school if user.school else 'Not set' }}</span>
                        </div>
                    </div>
                    <div class="info-detail-item">
                        <i class="fas fa-graduation-cap info-icon"></i>
                        <div class="info-content">
                            <span class="info-label">Education Level</span>
                            <span class="info-value">{{ education_display }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="profile-right-column">
            <!-- Account Security Section -->
            <div class="account-security-section card-shadow">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">Account Security</h2>
                        <p class="section-subtitle">Changing the password regularly can protect your account</p>
                    </div>
                </div>
                <div class="password-security-box">
                    <div class="password-security-header">
                        <i class="fas fa-shield-alt password-icon"></i>
                        <span class="password-security-label">Password Security</span>
                    </div>
                    <div class="password-last-changed">
                        Last changed: {{ password_last_changed }}
                    </div>
                </div>
                <button class="btn-change-password" onclick="openChangePasswordModal()">
                    Change Password
                </button>
                <div class="security-tips">
                    <h3 class="security-tips-title">Security Tips</h3>
                    <div class="security-tip-item">
                        <i class="fas fa-check-circle tip-icon"></i>
                        <span>Use a strong password with letters, numbers, and symbols</span>
                    </div>
                    <div class="security-tip-item">
                        <i class="fas fa-check-circle tip-icon"></i>
                        <span>Change your password every 3 months</span>
                    </div>
                    <div class="security-tip-item">
                        <i class="fas fa-check-circle tip-icon"></i>
                        <span>Never share your password with others</span>
                    </div>
                </div>
            </div>

            <!-- Grade Section -->
            <div class="grade-section card-shadow">
                <div class="grade-header">
                    <i class="fas fa-graduation-cap grade-icon"></i>
                    <span class="grade-label">Grade</span>
                </div>
                <div class="grade-value">{{ grade_display if grade_display else 'Not set' }}</div>
            </div>

            <!-- Check-in Record Section -->
            <div class="checkin-record-section card-shadow">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">Check-in Record</h2>
                        <p class="section-subtitle">Your study activity over the last 30 days</p>
                    </div>
                </div>
                <div class="checkin-metrics">
                    <div class="checkin-metric">
                        <span class="metric-label">Current streak</span>
                        <span class="metric-value">{{ streak_days }} days</span>
                    </div>
                    <div class="checkin-metric">
                        <span class="metric-label">Total check-ins</span>
                        <span class="metric-value">{{ total_checkins }} days</span>
                    </div>
                    <div class="checkin-metric">
                        <span class="metric-label">This month</span>
                        <span class="metric-value">{{ this_month_checkins }} days</span>
                    </div>
                </div>
                <div class="checkin-calendar-container">
                    <div class="checkin-calendar-label">Last 30 days</div>
                    <div class="checkin-calendar-grid">
                        {% for date_item in calendar_dates %}
                        <div class="checkin-calendar-day {% if date_item.checked_in %}checked-in{% else %}not-checked-in{% endif %}" 
                             title="{{ date_item.date }}">
                            {{ date_item.day }}
                        </div>
                        {% endfor %}
                    </div>
                    <div class="checkin-legend">
                        <div class="legend-item">
                            <div class="legend-color checked-in"></div>
                            <span>Checked in</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color not-checked-in"></div>
                            <span>Not checked in</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div id="editProfileModal" class="modal">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Personal Information</h3>
            <span class="close-modal" onclick="closeEditProfileModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="editProfileForm" method="POST" action="{{ url_for('update_profile', lang=lang) }}">
                <div class="form-row">
                    <div class="form-group half">
                        <label for="first_name">First Name</label>
                        <input type="text" id="first_name" name="first_name" value="{{ user.first_name }}" required>
                    </div>
                    <div class="form-group half">
                        <label for="last_name">Last Name</label>
                        <input type="text" id="last_name" name="last_name" value="{{ user.last_name }}" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input type="tel" id="phone" name="phone" value="{{ user.phone }}" required>
                </div>
                
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" value="{{ user.email }}" required>
                </div>
                
                <div class="form-group">
                    <label for="gender">Gender</label>
                    <select id="gender" name="gender">
                        <option value="" {% if not user.gender %}selected{% endif %}>Please select</option>
                        <option value="male" {% if user.gender == 'male' %}selected{% endif %}>Male</option>
                        <option value="female" {% if user.gender == 'female' %}selected{% endif %}>Female</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="birth_date">Date of Birth</label>
                    <input type="date" id="birth_date" name="birth_date" value="{{ user.birth_date }}">
                </div>
                
                <div class="form-group">
                    <label for="school">School</label>
                    <input type="text" id="school" name="school" value="{{ user.school }}">
                </div>
                
                <div class="form-group">
                    <label for="education_level">Education Level</label>
                    <select id="education_level" name="education_level" required>
                        {% for level in education_levels %}
                        <option value="{{ level }}" {% if user.education_level == level %}selected{% endif %}>{{ level }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="grade">Grade</label>
                    <select id="grade" name="grade">
                        <option value="" {% if not user.grade %}selected{% endif %}>Please select</option>
                    </select>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditProfileModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div id="changePasswordModal" class="modal">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Change Password</h3>
            <span class="close-modal" onclick="closeChangePasswordModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="changePasswordForm" method="POST" action="{{ url_for('change_password', lang=lang) }}">
                <div class="form-group">
                    <label for="current_password">Current Password</label>
                    <input type="password" id="current_password" name="current_password" required>
                </div>
                
                <div class="form-group">
                    <label for="new_password">New Password</label>
                    <input type="password" id="new_password" name="new_password" required>
                    <small class="password-tip">Password should contain at least 6 characters</small>
                </div>
                
                <div class="form-group">
                    <label for="confirm_new_password">Confirm New Password</label>
                    <input type="password" id="confirm_new_password" name="confirm_new_password" required>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeChangePasswordModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Change Password</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize grade selector
    const educationLevelSelect = document.getElementById('education_level');
    const gradeSelect = document.getElementById('grade');
    
    const gradeOptions = {
        '小学': ['一年级', '二年级', '三年级', '四年级', '五年级', '六年级'],
        '初中': ['初一', '初二', '初三'],
        '高中': ['高一', '高二', '高三'],
        '大学本科': ['大一', '大二', '大三', '大四'],
        '硕士研究生': ['研一', '研二', '研三'],
        '博士研究生': ['博一', '博二', '博三', '博四', '博五']
    };
    
    educationLevelSelect.addEventListener('change', function() {
        updateGradeOptions(this.value);
    });
    
    updateGradeOptions(educationLevelSelect.value);
    
    function updateGradeOptions(selectedLevel) {
        gradeSelect.innerHTML = '<option value="">Please select</option>';
        
        if (selectedLevel && gradeOptions[selectedLevel]) {
            gradeOptions[selectedLevel].forEach(grade => {
                const option = document.createElement('option');
                option.value = grade;
                option.textContent = grade;
                {% if user.grade %}
                if (grade === '{{ user.grade }}') {
                    option.selected = true;
                }
                {% endif %}
                gradeSelect.appendChild(option);
            });
        }
    }
});

// Modal functions
function openEditProfileModal() {
    document.getElementById('editProfileModal').style.display = 'flex';
}

function closeEditProfileModal() {
    document.getElementById('editProfileModal').style.display = 'none';
}

function openChangePasswordModal() {
    document.getElementById('changePasswordModal').style.display = 'flex';
}

function closeChangePasswordModal() {
    document.getElementById('changePasswordModal').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target === modal || event.target.classList.contains('modal-overlay')) {
            modal.style.display = 'none';
        }
    });
}
</script>
{% endblock %}
