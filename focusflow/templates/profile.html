{% extends "base.html" %}

{% block content %}
<div class="profile-page-container">
    <!-- Page Header -->
    <div class="profile-page-header">
        <h1 class="profile-page-title">{{ translations.profile }}</h1>
        <p class="profile-page-subtitle">{{ translations.manage_profile }}</p>
    </div>

    <!-- Main Content Grid -->
    <div class="profile-main-grid">
        <!-- Left Column -->
        <div class="profile-left-column">
            <!-- User Profile Card -->
            <div class="user-profile-card card-shadow">
                <div class="profile-avatar-container">
                    {% if user.profile_picture %}
                    <div class="profile-avatar-large profile-avatar-image" style="background-image: url('{{ url_for('static', filename='uploads/avatars/' ~ user.profile_picture) }}');">
                    </div>
                    {% else %}
                    <div class="profile-avatar-large" style="background-color: {{ g.user_avatar_color|default('#ffd700') }}">
                        {{ g.initials|default('UU') }}
                    </div>
                    {% endif %}
                    <button class="avatar-edit-btn" onclick="triggerAvatarUpload()" title="{{ translations.change_avatar|default('Change profile picture') }}">
                        <i class="fas fa-camera"></i>
                    </button>
                    <input type="file" id="avatar-upload" accept="image/png,image/jpeg,image/jpg,image/gif,image/webp" style="display: none;" onchange="uploadAvatar(this)">
                </div>
                <div class="profile-name">{{ user.first_name }} {{ user.last_name }}</div>
                <div class="profile-school-info">
                    {{ user.school if user.school else translations.no_school }} â€¢ {{ grade_display }}
                </div>
                <div class="profile-badges">
                    <span class="profile-badge badge-education">{{ education_display }}</span>
                    <span class="profile-badge badge-checkin">{{ this_month_checkins }} {{ translations.days_checked_in }}</span>
                    <span class="profile-badge badge-streak">{{ streak_days }} {{ translations['days'] }} {{ translations.streak }}</span>
                </div>
            </div>

            <!-- Personal Information Section -->
            <div class="personal-info-section card-shadow">
                <div class="section-header-with-action">
                    <div>
                        <h2 class="section-title">{{ translations.personal_information }}</h2>
                        <p class="section-subtitle">{{ translations.basic_profile_details }}</p>
                    </div>
                    <button class="btn-edit-section" onclick="openEditProfileModal()">
                        <i class="fas fa-pencil-alt"></i> {{ translations.edit }}
                    </button>
                </div>
                <div class="info-details-list">
                    <div class="info-detail-item">
                        <i class="fas fa-user info-icon"></i>
                        <div class="info-content">
                            <span class="info-label">{{ translations.gender }}</span>
                            <span class="info-value">{{ translations.male if user.gender == 'male' else translations.female if user.gender == 'female' else translations.not_set }}</span>
                        </div>
                    </div>
                    <div class="info-detail-item">
                        <i class="far fa-calendar info-icon"></i>
                        <div class="info-content">
                            <span class="info-label">{{ translations.date_of_birth }}</span>
                            <span class="info-value">
                                {% if user.birth_date %}
                                    {% set birth_date = user.birth_date.split(' ')[0] if ' ' in user.birth_date else user.birth_date %}
                                    {% set date_parts = birth_date.split('-') %}
                                    {% if date_parts|length == 3 %}
                                        {% set months = translations.months if translations.months is defined else ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'] %}
                                        {{ months[date_parts[1]|int - 1] }} {{ date_parts[2]|int }}, {{ date_parts[0] }}
                                    {% else %}
                                        {{ user.birth_date }}
                                    {% endif %}
                                {% else %}
                                    {{ translations.not_set }}
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    <div class="info-detail-item">
                        <i class="fas fa-school info-icon"></i>
                        <div class="info-content">
                            <span class="info-label">{{ translations.school }}</span>
                            <span class="info-value">{{ user.school if user.school else translations.not_set }}</span>
                        </div>
                    </div>
                    <div class="info-detail-item">
                        <i class="fas fa-graduation-cap info-icon"></i>
                        <div class="info-content">
                            <span class="info-label">{{ translations.education_level }}</span>
                            <span class="info-value">{{ education_display }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="profile-right-column">
            <!-- Account Security Section -->
            <div class="account-security-section card-shadow">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">{{ translations.account_security }}</h2>
                        <p class="section-subtitle">{{ translations.change_password_subtitle }}</p>
                    </div>
                </div>
                <div class="password-security-box">
                    <div class="password-security-header">
                        <i class="fas fa-shield-alt password-icon"></i>
                        <span class="password-security-label">{{ translations.password_security }}</span>
                    </div>
                    <div class="password-last-changed">
                        {{ translations.last_changed }}: {{ password_last_changed }}
                    </div>
                </div>
                <button class="btn-change-password" onclick="openChangePasswordModal()">
                    {{ translations.change_password }}
                </button>
                <div class="security-tips">
                    <h3 class="security-tips-title">{{ translations.security_tips }}</h3>
                    <div class="security-tip-item">
                        <i class="fas fa-check-circle tip-icon"></i>
                        <span>{{ translations.tip_1 }}</span>
                    </div>
                    <div class="security-tip-item">
                        <i class="fas fa-check-circle tip-icon"></i>
                        <span>{{ translations.tip_2 }}</span>
                    </div>
                    <div class="security-tip-item">
                        <i class="fas fa-check-circle tip-icon"></i>
                        <span>{{ translations.tip_3 }}</span>
                    </div>
                </div>
            </div>


            <!-- Check-in Record Section -->
            <div class="checkin-record-section card-shadow">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">{{ translations.checkin_record }}</h2>
                        <p class="section-subtitle">{{ translations.activity_30_days }}</p>
                    </div>
                </div>
                <div class="checkin-metrics">
                    <div class="checkin-metric">
                        <span class="metric-label">{{ translations.current_streak }}</span>
                        <span class="metric-value">{{ streak_days }} {{ translations['days'] }}</span>
                    </div>
                    <div class="checkin-metric">
                        <span class="metric-label">{{ translations.total_checkins }}</span>
                        <span class="metric-value">{{ total_checkins }} {{ translations['days'] }}</span>
                    </div>
                    <div class="checkin-metric">
                        <span class="metric-label">{{ translations.this_month }}</span>
                        <span class="metric-value">{{ this_month_checkins }} {{ translations['days'] }}</span>
                    </div>
                </div>
                <div class="checkin-calendar-container">
                    <div class="checkin-calendar-label">{{ translations.last_30_days }}</div>
                    <div class="checkin-calendar-grid">
                        {% for date_item in calendar_dates %}
                        <div class="checkin-calendar-day {% if date_item.checked_in %}checked-in{% else %}not-checked-in{% endif %}" 
                             title="{{ date_item.date }}">
                            {{ date_item.day }}
                        </div>
                        {% endfor %}
                    </div>
                    <div class="checkin-legend">
                        <div class="legend-item">
                            <div class="legend-color checked-in"></div>
                            <span>{{ translations.legend_checked_in }}</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color not-checked-in"></div>
                            <span>{{ translations.legend_not_checked_in }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div id="editProfileModal" class="modal">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>{{ translations.edit_personal_info }}</h3>
            <span class="close-modal" onclick="closeEditProfileModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="editProfileForm" method="POST" action="{{ url_for('update_profile', lang=lang) }}">
                <div class="form-row">
                    <div class="form-group half">
                        <label for="first_name">{{ translations.first_name }}</label>
                        <input type="text" id="first_name" name="first_name" value="{{ user.first_name }}" required>
                    </div>
                    <div class="form-group half">
                        <label for="last_name">{{ translations.last_name }}</label>
                        <input type="text" id="last_name" name="last_name" value="{{ user.last_name }}" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="phone">{{ translations.phone }}</label>
                    <input type="tel" id="phone" name="phone" value="{{ user.phone }}" required>
                </div>
                
                <div class="form-group">
                    <label for="email">{{ translations.email }}</label>
                    <input type="email" id="email" name="email" value="{{ user.email }}" required>
                </div>
                
                <div class="form-group">
                    <label for="gender">{{ translations.gender }}</label>
                    <select id="gender" name="gender">
                        <option value="" {% if not user.gender %}selected{% endif %}>{{ translations.please_select }}</option>
                        <option value="male" {% if user.gender == 'male' %}selected{% endif %}>{{ translations.male }}</option>
                        <option value="female" {% if user.gender == 'female' %}selected{% endif %}>{{ translations.female }}</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="birth_date">{{ translations.date_of_birth }}</label>
                    <input type="date" id="birth_date" name="birth_date" value="{{ user.birth_date }}">
                </div>
                
                <div class="form-group">
                    <label for="school">{{ translations.school }}</label>
                    <input type="text" id="school" name="school" value="{{ user.school }}">
                </div>
                
                <div class="form-group">
                    <label for="education_level">{{ translations.education_level }}</label>
                    <select id="education_level" name="education_level" required>
                        {% for level in education_levels %}
                        <option value="{{ level }}" {% if user.education_level == level %}selected{% endif %}>{{ level }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="grade">Grade</label>
                    <select id="grade" name="grade">
                        <option value="" {% if not user.grade %}selected{% endif %}>{{ translations.please_select }}</option>
                    </select>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditProfileModal()">{{ translations.cancel }}</button>
                    <button type="submit" class="btn btn-primary">{{ translations.save_changes }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div id="changePasswordModal" class="modal">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>{{ translations.change_password }}</h3>
            <span class="close-modal" onclick="closeChangePasswordModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="changePasswordForm" method="POST" action="{{ url_for('change_password', lang=lang) }}">
                <div class="form-group">
                    <label for="current_password">{{ translations.current_password }}</label>
                    <input type="password" id="current_password" name="current_password" required>
                </div>
                
                <div class="form-group">
                    <label for="new_password">{{ translations.new_password }}</label>
                    <input type="password" id="new_password" name="new_password" required>
                    <small class="password-tip">{{ translations.password_tip }}</small>
                </div>
                
                <div class="form-group">
                    <label for="confirm_new_password">{{ translations.confirm_password }}</label>
                    <input type="password" id="confirm_new_password" name="confirm_new_password" required>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeChangePasswordModal()">{{ translations.cancel }}</button>
                    <button type="submit" class="btn btn-primary">{{ translations.change_password }}</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize grade selector
    const educationLevelSelect = document.getElementById('education_level');
    const gradeSelect = document.getElementById('grade');
    
    const gradeOptions = {
        'Elementary School': ['Grade 1', 'Grade 2', 'Grade 3', 'Grade 4', 'Grade 5', 'Grade 6'],
        'Junior High School': ['Grade 7', 'Grade 8', 'Grade 9'],
        'Senior High School': ['Grade 10', 'Grade 11', 'Grade 12'],
        'Undergraduate': ['Freshman', 'Sophomore', 'Junior', 'Senior'],
        'Master': ['Year 1', 'Year 2', 'Year 3'],
        'PhD': ['Year 1', 'Year 2', 'Year 3', 'Year 4', 'Year 5']
    };
    
    educationLevelSelect.addEventListener('change', function() {
        updateGradeOptions(this.value);
    });
    
    updateGradeOptions(educationLevelSelect.value);
    
    function updateGradeOptions(selectedLevel) {
        gradeSelect.innerHTML = '<option value="">Please select</option>';
        
        if (selectedLevel && gradeOptions[selectedLevel]) {
            gradeOptions[selectedLevel].forEach(grade => {
                const option = document.createElement('option');
                option.value = grade;
                option.textContent = grade;
                {% if user.grade %}
                if (grade === '{{ user.grade }}') {
                    option.selected = true;
                }
                {% endif %}
                gradeSelect.appendChild(option);
            });
        }
    }
});

// Modal functions
function openEditProfileModal() {
    document.getElementById('editProfileModal').style.display = 'flex';
}

function closeEditProfileModal() {
    document.getElementById('editProfileModal').style.display = 'none';
}

function openChangePasswordModal() {
    document.getElementById('changePasswordModal').style.display = 'flex';
}

function closeChangePasswordModal() {
    document.getElementById('changePasswordModal').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target === modal || event.target.classList.contains('modal-overlay')) {
            modal.style.display = 'none';
        }
    });
}

// Avatar upload functions
function triggerAvatarUpload() {
    document.getElementById('avatar-upload').click();
}

function uploadAvatar(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Check file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert(window.TRANSLATIONS.file_too_large || 'File is too large. Maximum size is 5MB.');
            return;
        }
        
        // Check file type
        const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
            alert(window.TRANSLATIONS.invalid_file_type || 'Invalid file type. Please upload PNG, JPG, JPEG, GIF, or WebP.');
            return;
        }
        
        // Create FormData and upload
        const formData = new FormData();
        formData.append('avatar', file);
        
        // Show loading state
        const avatarBtn = document.querySelector('.avatar-edit-btn');
        const originalIcon = avatarBtn.innerHTML;
        avatarBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        avatarBtn.disabled = true;
        
        fetch('{{ url_for("upload_avatar") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the avatar display
                const avatarContainer = document.querySelector('.profile-avatar-container');
                const avatarElement = avatarContainer.querySelector('.profile-avatar-large');
                
                // Replace with image
                avatarElement.style.backgroundImage = `url('${data.avatar_url}')`;
                avatarElement.style.backgroundSize = 'cover';
                avatarElement.style.backgroundPosition = 'center';
                avatarElement.classList.add('profile-avatar-image');
                avatarElement.textContent = '';  // Remove initials
                
                // Also update the header avatar if it exists
                const headerAvatar = document.querySelector('.user-avatar-header');
                if (headerAvatar) {
                    headerAvatar.style.backgroundImage = `url('${data.avatar_url}')`;
                    headerAvatar.style.backgroundSize = 'cover';
                    headerAvatar.style.backgroundPosition = 'center';
                    headerAvatar.textContent = '';
                }
                
                // Show success message
                if (typeof showNotification === 'function') {
                    showNotification(data.message);
                } else {
                    alert(data.message);
                }
            } else {
                alert(data.message || window.TRANSLATIONS.avatar_update_failed || 'Failed to update profile picture.');
            }
        })
        .catch(error => {
            console.error('Error uploading avatar:', error);
            alert(window.TRANSLATIONS.avatar_update_failed || 'Failed to update profile picture. Please try again.');
        })
        .finally(() => {
            // Restore button state
            avatarBtn.innerHTML = originalIcon;
            avatarBtn.disabled = false;
            // Clear the input so the same file can be selected again
            input.value = '';
        });
    }
}
</script>
{% endblock %}