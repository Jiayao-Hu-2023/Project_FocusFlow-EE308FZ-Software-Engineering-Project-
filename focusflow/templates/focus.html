{% extends "base.html" %}

{% block content %}
<div class="focus-page-container">
    <!-- Page Header -->
    <div class="focus-page-header">
        <h1 class="focus-page-title">{{ translations.focus_page_title }}</h1>
        <p class="focus-page-subtitle">{{ translations.focus_page_subtitle }}</p>
    </div>

    <!-- Main Content Grid -->
    <div class="focus-content-grid">
        <!-- Left Column: Focus Time Card -->
        <div class="focus-main-card">
            <div class="focus-card-header">
                <h2 class="focus-card-title">{{ translations.focus_time }}</h2>
                <p class="focus-card-subtitle">{{ translations.focus_time_subtitle }}</p>
            </div>
            
            <!-- Large Circular Timer -->
            <div class="timer-circle-container">
                <div class="timer-circle">
                    <span class="timer-display" id="timerDisplay">25:00</span>
                </div>
            </div>

            <!-- Subject Selection -->
            <div class="subject-selector">
                <label for="subject-select" class="subject-label">{{ translations.select_subject }}</label>
                <select id="subject-select" class="subject-dropdown">
                    <option value="">{{ translations.choose_subject }}</option>
                    {% if tasks %}
                        {% for task in tasks %}
                            {% if task.course %}
                            <option value="{{ task.course }}">{{ task.course }}</option>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </select>
            </div>

            <!-- Control Buttons -->
            <div class="timer-controls">
                <button class="btn-start-timer" id="startBtn">
                    <i class="fas fa-play"></i> {{ translations.start }}
                </button>
                <button class="btn-pause-timer" id="pauseBtn" style="display: none;">
                    <i class="fas fa-pause"></i> {{ translations.pause }}
                </button>
                <button class="btn-reset-timer" id="resetBtn" title="{{ translations.reset }}">
                    <i class="fas fa-redo"></i>
                </button>
            </div>

            <!-- Preset Time Buttons -->
            <div class="preset-times">
                <button class="preset-btn active" data-minutes="25">25 {{ translations['min'] }}</button>
                <button class="preset-btn" data-minutes="45">45 {{ translations['min'] }}</button>
                <button class="preset-btn" data-minutes="60">60 {{ translations['min'] }}</button>
            </div>

            <!-- Custom Time Input -->
            <div class="custom-time-section">
                <div class="custom-time-group">
                    <input type="number" id="customMinutes" min="1" max="240" placeholder="{{ translations.custom_minutes_placeholder }}">
                    <button id="setCustomTime" class="preset-btn">{{ translations.set }}</button>
                </div>
            </div>
        </div>

        <!-- Right Column: Stats Cards -->
        <div class="focus-stats-column">
            <!-- Today's Progress Card -->
            <div class="focus-stat-card">
                <h3 class="stat-card-title">{{ translations.todays_progress }}</h3>
                <div class="stat-card-content">
                    <div class="stat-large-value" id="todayProgress">{{ today_progress|default('0' ~ translations['h'] ~ ' 0' ~ translations['min']) }}</div>
                    <p class="stat-card-description">{{ translations.total_study_time }}</p>
                </div>
            </div>

            <!-- How it works Card -->
            <div class="focus-stat-card">
                <h3 class="stat-card-title">{{ translations.how_it_works }}</h3>
                <div class="how-it-works-list">
                    <div class="how-it-works-item">
                        <div class="step-number">1</div>
                        <p>{{ translations.how_it_works_1 }}</p>
                    </div>
                    <div class="how-it-works-item">
                        <div class="step-number">2</div>
                        <p>{{ translations.how_it_works_2 }}</p>
                    </div>
                    <div class="how-it-works-item">
                        <div class="step-number">3</div>
                        <p>{{ translations.how_it_works_3 }}</p>
                    </div>
                    <div class="how-it-works-item">
                        <div class="step-number">4</div>
                        <p>{{ translations.how_it_works_4 }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 自定义警告弹窗 -->
<div id="warningModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-icon-container">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="modal-title">{{ translations.focus_mode_warning }}</h3>
        </div>
        <div class="modal-body">
            <p class="modal-message">{{ translations.focus_mode_warning_message }}</p>
        </div>
        <div class="modal-footer">
            <button id="cancelBtn" class="modal-btn modal-btn-secondary">
                <i class="fas fa-times"></i> {{ translations.cancel }}
            </button>
            <button id="confirmBtn" class="modal-btn modal-btn-primary">
                <i class="fas fa-check"></i> {{ translations.continue }}
            </button>
        </div>
    </div>
</div>

<style>
/* 弹窗样式优化 - 黄色背景红色文字 */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    backdrop-filter: blur(8px);
    animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.modal-content {
    background: #fff3cd; /* 黄色背景 */
    border-radius: 16px;
    padding: 32px;
    max-width: 420px;
    width: 90%;
    box-shadow: 0 24px 48px rgba(0, 0, 0, 0.25);
    border: 2px solid #ffc107; /* 黄色边框 */
    animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.modal-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #ffc107, #ff9800); /* 黄色渐变 */
}

.modal-header {
    text-align: center;
    margin-bottom: 24px;
}

.modal-icon-container {
    width: 64px;
    height: 64px;
    background: linear-gradient(135deg, #ffc107, #ff9800); /* 黄色渐变 */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 16px;
    box-shadow: 0 8px 24px rgba(255, 193, 7, 0.3);
}

.modal-icon-container i {
    font-size: 28px;
    color: white;
}

.modal-title {
    color: #d32f2f; /* 红色文字 */
    font-size: 24px;
    font-weight: 700;
    margin: 0;
    line-height: 1.3;
    text-align: center;
}

.modal-body {
    margin-bottom: 28px;
    text-align: center;
}

.modal-message {
    color: #d32f2f; /* 红色文字 */
    font-size: 16px;
    line-height: 1.5;
    margin: 0;
}

.modal-footer {
    display: flex;
    gap: 12px;
    justify-content: center;
}

.modal-btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.modal-btn-primary {
    background: #d32f2f; /* 红色按钮 */
    color: white;
}

.modal-btn-primary:hover {
    background: #b71c1c;
    transform: translateY(-1px);
}

.modal-btn-secondary {
    background: #6c757d;
    color: white;
}

.modal-btn-secondary:hover {
    background: #5a6268;
    transform: translateY(-1px);
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}
</style>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/focus_timer.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 使用单例模式的计时器实例
        if (!window.focusTimer) {
            window.focusTimer = new FocusTimer();
        }

        // 获取DOM元素
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resetBtn = document.getElementById('resetBtn');
        const warningModal = document.getElementById('warningModal');
        const cancelBtn = document.getElementById('cancelBtn');
        const confirmBtn = document.getElementById('confirmBtn');

        // 显示/隐藏警告弹窗
        function showModal(targetRoute = '{{ url_for("focus", lang=lang) }}') {
            warningModal.style.display = 'flex';
            confirmBtn.dataset.targetRoute = targetRoute;
        }

        function hideModal() {
            warningModal.style.display = 'none';
        }

        // 弹窗按钮事件
        cancelBtn.addEventListener('click', hideModal);
        confirmBtn.addEventListener('click', function() {
            const targetRoute = this.dataset.targetRoute || '/focus';
            const isResetAction = targetRoute === '/focus'; // 判断是否是Reset操作
            
            hideModal();
            
            if (isResetAction) {
                // 如果是Reset操作，执行重置
                if (window.focusTimer) {
                    window.focusTimer.reset();
                    // 确保显示Start按钮
                    pauseBtn.style.display = 'none';
                    startBtn.style.display = 'inline-block';
                    
                    // 移除全局监听
                    document.removeEventListener('keydown', handleKeyPress);
                    document.removeEventListener('click', handleClick);
                }
            } else {
                // 如果是导航操作，暂停计时器并跳转
                if (window.focusTimer) {
                    window.focusTimer.pause();
                }
                // 跳转到目标页面
                window.location.href = targetRoute;
            }
        });

        // ESC键关闭弹窗
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && warningModal.style.display === 'flex') {
                hideModal();
            }
        });

        // 处理按键事件
        function handleKeyPress(event) {
            // 允许的功能键：空格（暂停/继续）、ESC（退出全屏）、F11（全屏）
            const allowedKeys = [' ', 'Escape', 'F11'];

            if (!allowedKeys.includes(event.key) && !event.ctrlKey && !event.metaKey) {
                event.preventDefault();
                showModal(); // 使用自定义弹窗
            }
        }

        // 处理点击事件
        function handleClick(event) {
            // 检查是否点击了警告对话框内部元素
            const isModalClick = event.target.closest('#warningModal') !== null;
            if (isModalClick) {
                return; // 如果是对话框内部点击，直接返回，不阻止
            }

            // 检查计时器是否正在运行，只有运行时才限制点击
            if (window.focusTimer && window.focusTimer.isRunning) {
                // 允许点击的元素：计时器控制按钮、预设时间按钮、自定义时间输入
                const allowedElements = [
                    'startBtn', 'pauseBtn', 'resetBtn', 'setCustomTime',
                    'customMinutes', 'subject-select'
                ];

                // 检查是否是预设时间按钮
                const isPresetBtn = event.target.classList.contains('preset-btn') &&
                                   event.target.id !== 'setCustomTime';

                // 如果点击的不是允许的元素，显示警告
                if (!allowedElements.includes(event.target.id) &&
                    !allowedElements.includes(event.target.parentElement?.id) &&
                    !isPresetBtn) {
                    event.preventDefault();

                    // 检测用户点击的是哪个导航按钮，并设置对应的目标路由（保留lang参数）
                    let targetRoute = '{{ url_for("focus", lang=lang) }}';

                    // 检查是否是导航链接
                    const navLink = event.target.closest('a.nav-link') || event.target.closest('a.sidebar-nav-item');
                    if (navLink) {
                        const href = navLink.getAttribute('href');
                        if (href) {
                            // 直接使用导航链接的href（它已经包含?lang=...）
                            targetRoute = href;
                        }
                    }

                    showModal(targetRoute); // 使用自定义弹窗，传入目标路由
                }
            }
        }


        // Start按钮事件
        startBtn.addEventListener('click', function() {
            if (window.focusTimer) {
                window.focusTimer.start();
                // 切换按钮显示
                startBtn.style.display = 'none';
                pauseBtn.style.display = 'inline-block';
                
                // 添加全局按键监听和点击监听
                document.addEventListener('keydown', handleKeyPress);
                document.addEventListener('click', handleClick);
            }
        });

        // Pause按钮事件
        pauseBtn.addEventListener('click', function() {
            if (window.focusTimer) {
                window.focusTimer.pause();
                // 切换按钮显示
                pauseBtn.style.display = 'none';
                startBtn.style.display = 'inline-block';
                
                // 移除全局监听
                document.removeEventListener('keydown', handleKeyPress);
                document.removeEventListener('click', handleClick);
            }
        });

        // Reset按钮事件
        resetBtn.addEventListener('click', function() {
            // 如果计时器正在运行，弹出警告对话框
            if (window.focusTimer && window.focusTimer.isRunning) {
                showModal('/focus'); // 重置时目标路由为/focus
            } else {
                // 如果计时器没有运行，直接重置
                if (window.focusTimer) {
                    window.focusTimer.reset();
                    // 确保显示Start按钮
                    pauseBtn.style.display = 'none';
                    startBtn.style.display = 'inline-block';
                    
                    // 移除全局监听
                    document.removeEventListener('keydown', handleKeyPress);
                    document.removeEventListener('click', handleClick);
                }
            }
        });

        // 预设时间按钮事件
        const presetBtns = document.querySelectorAll('.preset-btn');
        presetBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                // 如果计时器正在运行，完全忽略预设按钮的点击
                if (window.focusTimer && window.focusTimer.isRunning) {
                    console.log('计时器正在运行，预设时间按钮被忽略');
                    return; // 直接返回，不执行任何操作
                }
                
                // 移除所有预设按钮的active类
                presetBtns.forEach(b => b.classList.remove('active'));
                // 为点击的按钮添加active类（排除设置按钮）
                if (this.id !== 'setCustomTime') {
                    this.classList.add('active');
                }
                
                const minutes = parseInt(this.dataset.minutes) || 25;
                if (window.focusTimer) {
                    window.focusTimer.setDuration(minutes, 5); // 休息时间设为5分钟
                }
            });
        });

        // 自定义时间设置
        const setCustomTimeBtn = document.getElementById('setCustomTime');
        const customMinutesInput = document.getElementById('customMinutes');
        
        if (setCustomTimeBtn && customMinutesInput) {
            setCustomTimeBtn.addEventListener('click', function() {
                const customMinutes = parseInt(customMinutesInput.value);
                if (!isNaN(customMinutes) && customMinutes >= 1 && customMinutes <= 240) {
                    // 移除所有预设按钮的active类
                    presetBtns.forEach(b => b.classList.remove('active'));
                    
                    if (window.focusTimer) {
                        window.focusTimer.setDuration(customMinutes, 5); // 休息时间设为5分钟
                    }
                    
                    // 清空输入框
                    customMinutesInput.value = '';
                }
            });
        }

        // Localize reset tooltip
        if (resetBtn) {
            resetBtn.title = (window.TRANSLATIONS && window.TRANSLATIONS.reset) ? window.TRANSLATIONS.reset : 'Reset';
        }

        // 更新今日进度
        function updateTodayProgress() {
            fetch('/focus/stats')
                .then(response => response.json())
                .then(data => {
                    const hours = Math.floor(data.today_duration / 60);
                    const minutes = data.today_duration % 60;
                    const todayProgressEl = document.getElementById('todayProgress');
                    const t = (window.TRANSLATIONS || {});
                    const hLabel = t.h || 'h';
                    const mLabel = t.min || 'min';
                    if (todayProgressEl) {
                        if (hours > 0) {
                            todayProgressEl.textContent = `${hours}${hLabel} ${minutes}${mLabel}`;
                        } else {
                            todayProgressEl.textContent = `${minutes}${mLabel}`;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching stats:', error);
                });
        }

        // 初始化今日进度
        updateTodayProgress();
        
        // 每分钟更新一次进度
        setInterval(updateTodayProgress, 60000);
    });
</script>
{% endblock %}