{% extends "base.html" %}

{% block content %}
<div class="dashboard-container">
    <!-- 欢迎横幅 -->
    <div class="welcome-banner">
        <div class="welcome-content">
            <h1 class="welcome-greeting">{{ greeting }}</h1>
            <p class="welcome-subtitle">{{ translations.greeting_subtitle }}</p>
        </div>
        <div class="welcome-actions">
            {% if checked_in %}
            <div class="checkin-status-banner checked-in">
                <i class="fas fa-check-circle"></i>
                <span>{{ translations.signed_in }}</span>
            </div>
            {% else %}
            <form method="POST" action="{{ url_for('checkin', lang=lang) }}" class="checkin-form">
                <button type="submit" class="btn-signin">
                    <i class="fas fa-calendar-check"></i>
                    {{ translations.sign_in_now }}
                </button>
            </form>
            {% endif %}
        </div>
    </div>

    <!-- 功能卡片区域 -->
    <div class="feature-cards">
        <a href="{{ url_for('tasks', lang=lang) }}" class="feature-card task-card">
            <div class="feature-card-icon task-icon">
                <i class="fas fa-tasks"></i>
            </div>
            <h3 class="feature-card-title">{{ translations.task_management }}</h3>
        </a>
        <a href="{{ url_for('focus', lang=lang) }}" class="feature-card focus-card">
            <div class="feature-card-icon focus-icon">
                <i class="fas fa-hourglass-half"></i>
            </div>
            <h3 class="feature-card-title">{{ translations.focus }}</h3>
        </a>
        <a href="{{ url_for('reports', lang=lang) }}" class="feature-card report-card">
            <div class="feature-card-icon report-icon">
                <i class="fas fa-chart-bar"></i>
            </div>
            <h3 class="feature-card-title">{{ translations.study_report }}</h3>
        </a>
    </div>

    <!-- 主要内容区域 - 两列布局 -->
    <div class="dashboard-main-content">
        <!-- 左侧：今日任务 -->
        <div class="dashboard-card today-tasks-card">
            <div class="card-header">
                <h2 class="card-title">{{ translations.todays_task }}</h2>
                <div class="task-progress-header">
                    <div class="progress-bar-mini">
                        <div class="progress-fill-mini" style="width: {{ task_progress_percentage }}%"></div>
                    </div>
                    <span class="progress-text-mini">{{ completed_today }}/{{ total_today }} {{ translations.completed }}</span>
                </div>
            </div>
            <div class="task-list-container">
                {% for task in today_tasks %}
                <div class="task-item-modern {% if task.status == 'completed' %}task-completed{% endif %}">
                    <input type="checkbox" class="task-checkbox-modern" data-task-id="{{ task.id }}" {% if task.status == 'completed' %}checked{% endif %}>
                    <div class="task-content">
                        <span class="task-title-modern">{{ task.title }}</span>
                        <div class="task-meta">
                            {% if task.subject %}
                            <span class="task-subject">{{ task.subject }}</span>
                            {% endif %}
                            {% if task.due_time %}
                            <span class="task-time-modern"><i class="far fa-clock"></i> {{ task.due_time }}</span>
                            {% endif %}
                            {% if task.priority == 'high' %}
                            <span class="priority-badge priority-high">{{ translations.priority_high }}</span>
                            {% elif task.priority == 'medium' %}
                            <span class="priority-badge priority-medium">{{ translations.priority_medium }}</span>
                            {% else %}
                            <span class="priority-badge priority-low">{{ translations.priority_low }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}

                {% if not today_tasks %}
                <div class="empty-state-modern">
                    <i class="far fa-calendar-check empty-icon-modern"></i>
                    <p>{{ translations.no_tasks_today }}</p>
                </div>
                {% endif %}
            </div>
            <a href="{{ url_for('tasks', lang=lang) }}" class="view-all-link-modern">{{ translations.view_all_tasks }}</a>
        </div>

        <!-- 右侧：学习统计 -->
        <div class="dashboard-card learning-stats-card">
            <div class="card-header">
                <h2 class="card-title">{{ translations.learning_statistics }}</h2>
                <p class="card-subtitle">{{ translations.learning_stats_subtitle }}</p>
            </div>
            <div class="stats-content">
                <div class="main-stat">
                    <div class="stat-icon-large">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <p class="stat-label">{{ translations.this_week_focus_time }}</p>
                        <p class="stat-value-large">
                            {% if weekly_focus_time.hours %}{{ weekly_focus_time.hours }}{{ translations['h'] }} {% endif %}
                            {% if weekly_focus_time.minutes %}{{ weekly_focus_time.minutes }}{{ translations['min'] }}{% endif %}
                            {% if not weekly_focus_time.hours and not weekly_focus_time.minutes %}0{{ translations['min'] }}{% endif %}
                        </p>
                        <span class="stat-message positive">
                            <i class="fas fa-star"></i> {{ translations.focus_time_message }}
                        </span>
                    </div>
                </div>
                <div class="recent-activity">
                    <h3 class="activity-title">{{ translations.recent_activity }}</h3>
                    <div class="activity-list">
                        <!-- 这里可以添加最近活动列表 -->
                        <p class="activity-empty">{{ translations.no_recent_activity }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 任务复选框切换
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.task-checkbox-modern');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const taskId = this.dataset.taskId;
            const completed = this.checked;
            
            // 发送AJAX请求更新任务状态
            fetch(`/tasks/update_status/${taskId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: completed ? 'completed' : 'pending' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const taskItem = this.closest('.task-item-modern');
                    if (completed) {
                        taskItem.classList.add('task-completed');
                    } else {
                        taskItem.classList.remove('task-completed');
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                this.checked = !completed; // 恢复复选框状态
            });
        });
    });
});
</script>
{% endblock %}
