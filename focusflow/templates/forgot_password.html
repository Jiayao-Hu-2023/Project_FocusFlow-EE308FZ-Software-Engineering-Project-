{% extends "base.html" %}

{% block content %}
<div class="auth-container">
    <div class="auth-card">
        <h2>{{ translations.forgot_password }}</h2>
        
        <!-- Step 1: Enter Phone Number -->
        <div id="step1" class="step active">
            <form id="phoneForm" method="POST" action="{{ url_for('forgot_password', lang=lang) }}">
                <div class="form-group">
                    <label for="phone">{{ translations.phone }}</label>
                    <input type="tel" id="phone" name="phone" required placeholder="{{ translations.phone_registered_placeholder }}">
                </div>
                <button type="submit" class="btn">{{ translations.next }}</button>
            </form>
            <div class="auth-links">
                <a href="{{ url_for('login', lang=lang) }}">{{ translations.return_to_login }}</a>
            </div>
        </div>

        <!-- Step 2: Confirm User Information -->
        <div id="step2" class="step" style="display: none;">
            <div class="user-info-card">
                <h3>{{ translations.user_information }}</h3>
                <div class="user-details">
                    <div class="info-row">
                        <span class="label">{{ translations.first_name }}:</span>
                        <span id="userFirstName" class="value"></span>
                    </div>
                    <div class="info-row">
                        <span class="label">{{ translations.last_name }}:</span>
                        <span id="userLastName" class="value"></span>
                    </div>
                    <div class="info-row">
                        <span class="label">{{ translations.school_institution }}:</span>
                        <span id="userSchool" class="value"></span>
                    </div>
                    <div class="info-row">
                        <span class="label">{{ translations.email }}:</span>
                        <span id="userEmail" class="value"></span>
                    </div>
                </div>
                <div class="confirmation-message">
                    <p>{{ translations.confirm_this_is_you }}</p>
                </div>
                <div class="step-buttons">
                    <button type="button" class="btn btn-secondary" onclick="goBack()">{{ translations.back }}</button>
                    <button type="button" class="btn btn-primary" onclick="confirmIdentity()">{{ translations.confirm }}</button>
                </div>
            </div>
        </div>

        <!-- Step 3: Reset Password -->
        <div id="step3" class="step" style="display: none;">
            <form id="resetPasswordForm" method="POST" action="{{ url_for('reset_password', lang=lang) }}">
                <input type="hidden" id="resetPhone" name="phone">
                <div class="form-group">
                    <label for="newPassword">{{ translations.new_password }}</label>
                    <input type="password" id="newPassword" name="new_password" required placeholder="{{ translations.new_password_placeholder }}">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">{{ translations.confirm_password }}</label>
                    <input type="password" id="confirmPassword" name="confirm_password" required placeholder="{{ translations.confirm_new_password_placeholder }}">
                </div>
                <div class="step-buttons">
                    <button type="button" class="btn btn-secondary" onclick="goBack()">{{ translations.back }}</button>
                    <button type="submit" class="btn btn-primary">{{ translations.reset_password }}</button>
                </div>
            </form>
        </div>

        <!-- Step 4: Success Message -->
        <div id="step4" class="step" style="display: none;">
            <div class="success-card">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3>{{ translations.password_reset_success_title }}</h3>
                <p>{{ translations.password_reset_success_subtitle }}</p>
                <div class="success-buttons">
                    <a href="{{ url_for('login', lang=lang) }}" class="btn btn-primary">{{ translations.login_now }}</a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.step {
    transition: all 0.3s ease;
}

.step.active {
    display: block;
}

.user-info-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.user-details {
    margin-bottom: 20px;
}

.info-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    padding: 8px 0;
    border-bottom: 1px solid #e9ecef;
}

.label {
    font-weight: 600;
    color: #495057;
}

.value {
    color: #6c757d;
}

.confirmation-message {
    text-align: center;
    margin: 20px 0;
    padding: 15px;
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 5px;
}

.confirmation-message p {
    margin: 0;
    font-weight: 600;
    color: #856404;
}

.step-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
}

.btn-secondary {
    background: #6c757d;
    border-color: #6c757d;
}

.btn-secondary:hover {
    background: #5a6268;
    border-color: #545b62;
}

.success-card {
    text-align: center;
    padding: 30px;
}

.success-icon {
    font-size: 48px;
    color: #28a745;
    margin-bottom: 20px;
}

.success-buttons {
    margin-top: 20px;
}
</style>

<script>
let currentStep = 1;
let userData = {};

function showStep(step) {
    // Hide all steps
    document.querySelectorAll('.step').forEach(s => {
        s.style.display = 'none';
        s.classList.remove('active');
    });
    
    // Show current step
    const stepElement = document.getElementById('step' + step);
    if (stepElement) {
        stepElement.style.display = 'block';
        stepElement.classList.add('active');
    }
    currentStep = step;
}

function goBack() {
    if (currentStep > 1) {
        showStep(currentStep - 1);
    }
}

// Handle phone form submission
document.getElementById('phoneForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const phone = document.getElementById('phone').value;
    
    // Send AJAX request to verify phone number
    fetch('{{ url_for("verify_phone", lang=lang) }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ phone: phone })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            userData = data.user;
            // Display user information
            document.getElementById('userFirstName').textContent = userData.first_name;
            document.getElementById('userLastName').textContent = userData.last_name;
            document.getElementById('userSchool').textContent = userData.school;
            document.getElementById('userEmail').textContent = userData.email;
            
            showStep(2);
        } else {
            alert(data.message || window.TRANSLATIONS.phone_not_found || 'Phone number not found. Please check and try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert(window.TRANSLATIONS.generic_error_try_again || 'An error occurred. Please try again.');
    });
});

function confirmIdentity() {
    showStep(3);
    document.getElementById('resetPhone').value = userData.phone;
}

// Handle password reset form submission
document.getElementById('resetPasswordForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    fetch('{{ url_for("reset_password", lang=lang) }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStep(4);
        } else {
            alert(data.message || window.TRANSLATIONS.password_reset_failed || 'Password reset failed. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert(window.TRANSLATIONS.generic_error_try_again || 'An error occurred. Please try again.');
    });
});
</script>
{% endblock %}